import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./IdentityPicker.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{makeCancelable}from"../../Core/Util/Promise";import{format}from"../../Core/Util/String";import{IdentityCard}from"../../IdentityCard";import{Observer}from"../../Observer";import{Persona}from"../../Persona";import*as Resources from"../../Resources.IdentityPicker";import{TagPicker}from"../../TagPicker";import{Tooltip}from"../../TooltipEx";import{shouldShowIdentityCard}from"../IdentityPickerDropdown/IdentityPickerUtils";import{IdentityPickerSuggestionItem}from"../IdentityPickerSuggestionsList/IdentityPickerSuggestionItem";var IdentityPicker=function(e){function t(t){var r=e.call(this,t)||this;return r.emailRegex=RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i"),r.resolveEmailPromises=[],r.itemRefs={},r.tagPickerRef=React.createRef(),r.openedIdentityCard=new ObservableValue(void 0),r.outerElement=React.createRef(),r.lastSearchVal="",r.suggestions=new ObservableArray([]),r.suggestionsLoading=new ObservableValue(!1),r.areTagsEqual=function(e,t){return e.entityId===t.entityId},r.renderSuggestionItem=function(e){return React.createElement("div",{className:"flex-row flex-grow",onKeyDown:r.onKeyDownSuggestionItem},React.createElement(IdentityPickerSuggestionItem,tslib_1.__assign({},e,{onOpenPersonaCard:r.onOpenPersonaCard,ref:function(t){return r.itemRefs[e.item.entityId]=t},renderSuggestion:r.props.renderCustomIdentitySuggestion&&r.renderCustomSuggestionItem})))},r.onKeyDownSuggestionItem=function(e){e.defaultPrevented||37!==e.which&&27!==e.which&&9!==e.which||r.tagPickerRef.current&&(r.tagPickerRef.current.focus(),e.preventDefault())},r.createDefaultItem=function(e){return{displayName:e,originDirectory:"email",originId:e,entityId:e,entityType:"custom"}},r.onOpenPersonaCard=function(e){shouldShowIdentityCard(e)&&(r.openedIdentityCard.value=e)},r.onClosePersonaCard=function(){r.openedIdentityCard.value=void 0,r.tagPickerRef.current.focus()},r.shouldBlurClear=function(){return void 0===r.openedIdentityCard.value},r.onEmptyInputFocus=function(){r.updateSuggestionsList(r.props.pickerProvider.onEmptyInputFocus())},r.focusContactCardButton=function(e){r.itemRefs[e.entityId]&&r.itemRefs[e.entityId].focus()},r.onAddIdentity=function(e){!!r.props.pickerProvider.addIdentitiesToMRU&&r.props.pickerProvider.addIdentitiesToMRU([e]),r.props.onIdentityAdded(e)},r.onDelimitedSearch=function(e){e.map(function(e){return e.trim()}).filter(function(e){return r.emailRegex.test(e)&&!ObservableLike.getValue(r.props.selectedIdentities).some(function(t){return t.entityId===e})}).forEach(function(e){r.props.onIdentityAdded(r.createDefaultItem(e)),r.updateResolvedEmail(r.props.pickerProvider.onFilterIdentities(e),e)}),r.tagPickerRef.current&&r.tagPickerRef.current.clearTagPicker()},r.renderCustomSuggestionItem=function(e){return r.props.renderCustomIdentitySuggestion&&r.props.renderCustomIdentitySuggestion(e.item)},r.convertItemToPill=function(e,t){var n="email"===e.originDirectory;return r.props.convertItemToPill&&"custom"===e.entityType?r.props.convertItemToPill(e,t):{className:"bolt-identity-picker-pill flex-row",content:n?React.createElement(Tooltip,{text:format(Resources.UnknownUserOrGroup,e.displayName)},React.createElement("div",{className:"bolt-identity-picker-unresolved-email"},e.displayName)):e.displayName||e.mailNickname,onRenderFilledVisual:n?void 0:function(){return React.createElement(Persona,{className:"flex-row flex-center",identity:e,size:20})}}},r.onResolveSuggestions=function(e){r.lastSearchVal=e;var t=r.props.pickerProvider.onFilterIdentities(e,ObservableLike.getValue(r.props.selectedIdentities));null!==t&&(r.cachedResults[e]?r.suggestions.value=r.cachedResults[e].filter(function(e){return!ObservableLike.getValue(r.props.selectedIdentities).some(function(t){return t.entityId===e.entityId})}):r.updateSuggestionsList(t,e))},r.cachedResults={},r}return tslib_1.__extends(t,e),t.prototype.render=function(){var e=this;return React.createElement("div",{className:this.props.className,ref:this.outerElement},React.createElement(Observer,{openedIdentityCard:this.openedIdentityCard},function(t){return React.createElement(React.Fragment,null,React.createElement(TagPicker,{suggestionsLoading:e.suggestionsLoading,areTagsEqual:e.areTagsEqual,convertItemToPill:e.convertItemToPill,deliminator:e.props.onResolveEmail&&";",noResultsFoundText:Resources.IdentityPickerNoResultsText,onBlur:e.props.onBlur,onDelimitedSearch:e.props.onResolveEmail&&e.onDelimitedSearch,onEmptyInputFocus:e.onEmptyInputFocus,onSearchChanged:e.onResolveSuggestions,onSuggestionExpanded:e.focusContactCardButton,onTagAdded:e.onAddIdentity,onTagRemoved:e.props.onIdentityRemoved,onTagsRemoved:e.props.onIdentitiesRemoved,placeholderText:e.props.placeholderText||Resources.MultiIdentityPickerPlaceholderText,prefixIconProps:{className:"bolt-identity-picker-contact-icon secondary-text justify-center flex-center",iconName:"Contact",size:"medium"},ref:e.tagPickerRef,renderSuggestionItem:e.renderSuggestionItem,shouldBlurClear:e.shouldBlurClear,selectedTags:e.props.selectedIdentities,suggestions:e.suggestions,suggestionsLoadingText:Resources.Loading}),t.openedIdentityCard&&React.createElement(IdentityCard,{getEntityFromUniqueAttribute:e.props.pickerProvider.getEntityFromUniqueAttribute,key:t.openedIdentityCard.entityId,identity:t.openedIdentityCard,displayName:t.openedIdentityCard.displayName,target:e.outerElement.current,onDismissCallback:e.onClosePersonaCard,onRequestConnectionInformation:e.props.pickerProvider.onRequestConnectionInformation}))}))},t.prototype.componentWillUnmount=function(){this.currentPromise&&this.currentPromise.cancel();for(var e=0,t=this.resolveEmailPromises;e<t.length;e++){t[e].cancel()}},t.prototype.updateResolvedEmail=function(e,t){var r=this,n=e,i=e;if(Array.isArray(n))this.props.onResolveEmail&&1===n.length&&this.props.onResolveEmail(t,ObservableLike.getValue(this.props.selectedIdentities).some(function(e){return e.entityId===n[0].entityId})?null:n[0]);else if(i&&i.then){(this.currentPromise=makeCancelable(i)).promise.then(function(e){r.props.onResolveEmail&&1===e.length&&r.props.onResolveEmail(t,ObservableLike.getValue(r.props.selectedIdentities).some(function(t){return t.entityId===e[0].entityId})?null:e[0])})}},t.prototype.updateSuggestionsList=function(e,t){var r=this,n=e,i=e;if(Array.isArray(n))this.suggestions.value=n.filter(function(e){return!ObservableLike.getValue(r.props.selectedIdentities).some(function(t){return t.entityId===e.entityId})});else if(i&&i.then){this.suggestionsLoading.value=!0;var o=this.currentPromise=makeCancelable(i);this.resolveEmailPromises.push(o),o.promise.then(function(e){r.resolveEmailPromises=r.resolveEmailPromises.filter(function(e){return e!==o}),o===r.currentPromise&&(t&&r.lastSearchVal!==t||(r.suggestions.value=e.filter(function(e){return!ObservableLike.getValue(r.props.selectedIdentities).some(function(t){return t.entityId===e.entityId})})),t&&""!==t&&r.suggestions.value&&r.suggestions.value.length>0&&(r.cachedResults[t]=e),r.suggestionsLoading.value=!1)},function(){r.resolveEmailPromises=r.resolveEmailPromises.filter(function(e){return e!==o})})}},t}(React.Component);export{IdentityPicker};