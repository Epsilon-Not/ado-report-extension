import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./Filter.css";import*as React from"react";import{ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{format}from"../../Core/Util/String";import{Button}from"../../Button";import{Dropdown,DropdownCalloutComponent,DropdownExpandableButton,filterItems}from"../../Dropdown";import{FocusZoneContext}from"../../FocusZone";import{Icon}from"../../Icon";import{renderListCell}from"../../List";import{getListBoxItemsValue,ListBox,wrapListBoxItems}from"../../ListBox";import{Observer,SelectionObserver}from"../../Observer";import{Pill}from"../../Pill";import*as Resources from"../../Resources.Filter";import{TextField}from"../../TextField";import{css}from"../../Util";import{updateFilterToSelection}from"../../Utilities/DropdownFilter";import{DropdownMultiSelection}from"../../Utilities/DropdownSelection";import{FILTER_CHANGE_EVENT}from"../../Utilities/Filter";import{ScreenSizeObserver}from"../../Utilities/ScreenSize";import{compareSelectionRanges,indexWithinRanges}from"../../Utilities/Selection";var FilterCalloutWidth=320,FilterItemPadding=48,Filter=function(e){function t(t){var r=e.call(this,t)||this;return r.dropdown=React.createRef(),r.dropdownCallout=React.createRef(),r.filterText=new ObservableValue(""),r.collapse=function(){r.dropdown.current&&r.dropdown.current.collapse()},r.expand=function(){r.dropdown.current&&r.dropdown.current.expand()},r.onDoneClick=function(){var e=r.props.filterStore;e.usesApplyMode()&&e.applyChanges(),r.collapse()},r.onApplyClick=function(){var e=r.props.filterStore;e.usesApplyMode()&&e.applyChanges(),r.clearActiveFilter()},r.renderBeforeContent=function(){return React.createElement(Observer,{activeFilter:r.activeFilter,filterText:r.filterText,bestHitItem:r.props.bestHitItem,userFilteredItems:r.props.userFilteredItems},function(e){return e.activeFilter?e.activeFilter.renderBeforeContent?e.activeFilter.renderBeforeContent(r.clearActiveFilter):null:e.filterText?r.renderFilteredView():r.renderFilterItems()})},r.renderFilteredView=function(){var e=[];return r.props.bestHitItem&&r.props.bestHitItem.value&&(e.push({id:"best-hit-header",text:Resources.BestHit,type:2,className:"bolt-filtered-header"}),e.push(r.props.bestHitItem.value)),r.props.userFilteredItems?e.push.apply(e,getListBoxItemsValue(r.props.userFilteredItems)):(r.props.filterItems.forEach(function(t){var o=filterItems(getListBoxItemsValue(t.items),r.filterText.value||"").filteredItems,l=r.getSelectedFilterItems(t);(o=o.filter(function(e){return 2!==e.type&&3!==e.type&&-1===l.indexOf(e)&&(!r.props.bestHitItem||r.props.bestHitItem.value!==e)})).length&&(e.push({id:t.id,text:t.name,type:2,className:"bolt-filtered-header"}),e.push.apply(e,o.map(function(e){return tslib_1.__assign({},e,{groupId:t.id})})))}),r.props.filterItems.some(function(e){return"keyword-item"===e.id})&&e.push.apply(e,getKeywordSearchResults(r.filterText.value))),React.createElement(ListBox,{items:e,onSelect:r.onFilteredItemSelect,onActivate:r.onFilteredItemSelect,excludeTabStop:!0,focuszoneProps:null})},r.renderSelectedItems=function(e,t){return!1!==r.props.showFilterOnText&&r.filtered()?Resources.FilterOn:Resources.Filter},r.renderFilterItems=function(){return React.createElement(FocusZoneContext.Consumer,null,function(e){return r.props.filterItems.map(function(t,o){var l=r.getSelectedFilterItems(t),i=l.length,n=r.props.filterStore.getFilterItemState(t.filterItemKey);return React.createElement("div",{className:"flex-row flex-center bolt-filter-item",key:t.id,"data-focuszone":e.focuszoneId,tabIndex:-1,onClick:function(){return r.onFilterItemSelected(t)},onKeyDown:function(e){e.defaultPrevented||13!==e.which&&32!==e.which&&39!==e.which||(r.onFilterItemSelected(t),e.preventDefault())}},React.createElement("div",{className:css("flex-row flex-grow bolt-filter-label",n&&n.value&&0!==n.value.length&&"bolt-filter-label-selected"),style:{width:r.props.width-FilterItemPadding}},t.name,i>0&&React.createElement(Pill,{className:"bolt-filter-selection-pill",size:0},i),React.createElement("div",{className:"flex-grow flex-row bolt-filter-selected-item-container"},t.renderSelectedItems?t.renderSelectedItems(l):r.renderSelectedFilterItems(l))),React.createElement(Icon,{iconName:"ChevronRight"}))})})},r.renderSelectedFilterItems=function(e){var t=e.some(function(e){return!!e.iconProps});return React.createElement(React.Fragment,null,e.map(function(r,o){return React.createElement("div",{className:css("bolt-filter-selected-item flex-row",!t&&"bolt-filter-selected-text-item"),key:r.id},renderListCell(r),!t&&o!==e.length-1&&React.createElement("span",null,", "))}))},r.onFilteredItemSelect=function(e,t){if(t.groupId){var o=r.props.filterStore,l=o.getFilterItemState(t.groupId),i=void 0!==t.data?t.data:t.id;"keyword"===t.groupId?o.setFilterItemState(t.groupId,{value:t.id}):l&&l.value&&Array.isArray(l.value)?o.setFilterItemState(t.groupId,{value:l.value.concat([i])}):o.setFilterItemState(t.groupId,{value:[i]})}r.filterText.value="",r.dropdownCallout.current&&r.dropdownCallout.current.focus()},r.onFilterChanged=function(e){var t=r.props.filterStore.getState(),o=new DropdownMultiSelection,l=getListBoxItemsValue(r.wrappedItems||r.props.items),i=function(e){var r=t[e];if(r&&r.value)for(var i=function(e){var t=l.findIndex(function(t){return t.id===r.value[e]||t.data===r.value[e]});t>-1&&o.select(t,1,!0)},n=0;n<r.value.length;n++)i(n)};for(var n in t)i(n);compareSelectionRanges(r.selection.value,o.value).length&&(r.selection.value=o.value)},r.onSelectionChanged=function(e){var t=getListBoxItemsValue(r.wrappedItems||r.props.items);if(r.props.filterStore&&r.activeFilter.value){for(var o=new DropdownMultiSelection,l=0,i=0;r.props.filterItems[i].id!==r.activeFilter.value.id;i++)l+=r.props.filterItems[i].items.length;e.forEach(function(e){for(var t=e.beginIndex;t<=e.endIndex;t++)t>=l&&t<l+r.activeFilter.value.items.length&&o.select(t,1,!0)}),updateFilterToSelection(o.value,t,r.props.filterStore,r.activeFilter.value.filterItemKey)}return!0},r.onResetClick=function(){r.dropdownCallout.current&&r.dropdownCallout.current.focus(),r.props.filterStore.reset()},r.onFilterItemSelected=function(e){r.dropdownCallout.current&&r.dropdownCallout.current.focus(),r.props.activeFilter||(r.activeFilter.value=e),r.props.onActiveFilterChanged&&r.props.onActiveFilterChanged(e)},r.getOnFilterTextChanged=function(e){return function(t,o){r.filterText.value=o,r.activeFilter.value&&e.onFilterTextChanged&&(e.onFilterTextChanged(t,o),r.dropdownOnFilterTextChanged=e.onFilterTextChanged),r.props.onFilterTextChanged&&r.props.onFilterTextChanged(t,o)}},r.getFilterStartingIndex=function(e){if(e){for(var t=r.props.filterItems.indexOf(e),o=0,l=0;l<t;l++)o+=r.props.filterItems[l].items.length;return o}return-1},r.getSelectedFilterItems=function(e){for(var t=[],o=getListBoxItemsValue(r.wrappedItems||r.props.items),l=r.getFilterStartingIndex(e),i=l;i<l+e.items.length;i++)indexWithinRanges(i,r.selection.value)&&t.push(o[i]);return t},r.clearFilterSelection=function(){r.activeFilter.value&&r.props.filterStore.setFilterItemState(r.activeFilter.value.filterItemKey,{value:null})},r.clearActiveFilter=function(){r.dropdownCallout.current&&r.dropdownCallout.current.focus(),r.props.activeFilter||(r.activeFilter.value=null),r.props.onActiveFilterChanged&&r.props.onActiveFilterChanged(null),r.filterText.value="",r.dropdownOnFilterTextChanged&&r.dropdownOnFilterTextChanged(null,"")},r.filtered=function(){var e=r.props.filterStore.getAppliedState();for(var t in e)if(e[t].value&&(!Array.isArray(e[t].value)||e[t].value.length>0))return!0;return!1},r.state={},r.selection=t.selection||new DropdownMultiSelection,r.wrappedItems=wrapListBoxItems(t.items),r.activeFilter=t.activeFilter||new ObservableValue(null),r}return tslib_1.__extends(t,e),t.prototype.focus=function(){this.dropdown.current&&this.dropdown.current.focus()},t.prototype.componentDidMount=function(){this.props.filterStore&&this.props.filterStore.subscribe(this.onFilterChanged,FILTER_CHANGE_EVENT),this.onFilterChanged(this.props.filterStore.getState())},t.prototype.componentWillUnmount=function(){this.props.filterStore&&this.props.filterStore.unsubscribe(this.onFilterChanged,FILTER_CHANGE_EVENT)},t.prototype.render=function(){var e=this,t=this.props,r=t.filterStore,o=t.showActiveFilterResetButton,l=!1!==t.showFilterOnText&&this.filtered();return React.createElement(Observer,{activeFilter:this.activeFilter,filter:r},React.createElement(SelectionObserver,{selection:this.selection,onSelectionChanged:this.onSelectionChanged},function(){var t=e.activeFilter.value,i=[],n=0,s={className:"bolt-filter-reset-button",text:Resources.Reset,subtle:!1,onClick:e.onResetClick,id:"filter-reset-button"};if(t){var a=r.getFilterItemState(t.filterItemKey);n=e.getSelectedFilterItems(t).length,o?r.hasChangesToReset()&&i.push(s):i.push({text:Resources.Clear,disabled:!(a&&a.value),subtle:!1,onClick:e.clearFilterSelection,id:"filter-clear-button"}),i.push({className:css(!o&&"bolt-filter-apply-button"),disabled:r.usesApplyMode()&&!r.hasChangesToApply(),text:r.usesApplyMode()?Resources.Apply:Resources.Done,primary:!0,subtle:!1,onClick:e.onApplyClick,id:"filter-apply-button"})}else r.hasChangesToReset()&&i.push(s),i.push({disabled:r.usesApplyMode()&&!r.hasChangesToApply(),text:r.usesApplyMode()?Resources.Apply:Resources.Done,primary:!0,subtle:!1,onClick:e.onDoneClick,id:"filter-done-button"});return React.createElement(ScreenSizeObserver,null,function(r){var o=0===r.screenSize;return React.createElement(Dropdown,{actions:i,calloutContentClassName:css("bolt-filter-callout",t&&"bolt-active-filter",o&&"absolute-fill"),className:css(e.props.className,"bolt-filter",l&&"bolt-filter-on"),dismissOnSelect:!1,filterByText:e.props.filterByText,onCollapse:e.clearActiveFilter,placeholder:l?Resources.FilterOn:Resources.Filter,ref:e.dropdown,items:e.props.items,userFilteredItems:t?e.props.userFilteredItems?e.props.userFilteredItems:t.items:[],renderExpandable:function(t){return React.createElement(DropdownExpandableButton,tslib_1.__assign({},t,{iconProps:{iconName:"Filter"},hideDropdownIcon:!0,renderSelectedItems:e.renderSelectedItems}))},renderCallout:function(r){return React.createElement(DropdownCalloutComponent,tslib_1.__assign({},r,{anchorElement:o?void 0:r.anchorElement,anchorOrigin:{horizontal:"start",vertical:"end"},blurDismiss:!o,contentLocation:o?1:void 0,dropdownOrigin:{horizontal:"start",vertical:"start"},containerClassName:"bolt-filter-listbox-container",filterText:e.filterText,ignoreMouseDown:!0,onFilterTextChanged:e.getOnFilterTextChanged(r),showCloseButton:!0,title:t?React.createElement("div",{className:"flex-row flex-center bolt-filter-title-container"},!e.props.hideBackButton&&React.createElement(Button,{subtle:!0,className:"bolt-dropdown-header-button bolt-filter-back-button",iconProps:{iconName:"Back"},onClick:e.clearActiveFilter,tabIndex:-1}),t.title||t.name,n>0&&React.createElement(Pill,{className:"bolt-filter-selection-pill",size:0},n)):e.props.title||Resources.FilterTitle,renderBeforeContent:e.renderBeforeContent,ref:e.dropdownCallout}))},selection:e.selection,showFilterBox:!t||!(!1===t.showFilterBox),width:e.props.width})})}))},t.defaultProps={width:FilterCalloutWidth},t}(React.Component);export{Filter};export function getKeywordFilterItem(e,t){var r=new TimerManagement,o=function(t){e.setFilterItemState("keyword",{value:t}),e.usesApplyMode()||e.applyChanges()},l=t?r.debounce(o,t,{leading:!1,trailing:!0}):o;return{items:[],renderBeforeContent:function(t){var r=new ObservableValue(""),o=e.getFilterItemState("keyword");return r.value=o&&o.value?o.value:"",React.createElement(Observer,{filterExpression:{observableValue:e,filter:function(){var t=e.getFilterItemState("keyword");r.value=t&&t.value?t.value:""}}},function(){return React.createElement(TextField,{autoFocus:!0,className:"bolt-filter-keyword-item",value:r,onChange:function(e,t){r.value=t,l(t)},onKeyDown:function(e){13===e.which&&(t(),e.preventDefault())}})})},renderSelectedItems:function(){var t=e.getFilterItemState("keyword");return t&&t.value?React.createElement("span",null,'"'+t.value+'"'):null},id:"keyword-item",filterItemKey:"keyword",name:Resources.Keyword,showFilterBox:!1}};export function getKeywordSearchResults(e){var t=[];return t.push({id:"keyword-header",text:Resources.Keyword,type:2,className:"bolt-filtered-header"}),t.push({id:e,text:format(Resources.KeywordSearchResult,e),groupId:"keyword"}),t};