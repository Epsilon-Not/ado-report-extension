import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./ListBox.css";import*as React from"react";import{ObservableLike}from"../../Core/Observable";import*as Utils_Accessibility from"../../Core/Util/Accessibility";import{format}from"../../Core/Util/String";import{renderListCell}from"../../List";import{ItemsObserver,Observer}from"../../Observer";import*as Resources from"../../Resources.Dropdown";import{Spinner}from"../../Spinner";import{ColumnSelect,renderEmptyCell,SimpleTableCell,Table,TableRow}from"../../Table";import{css}from"../../Util";import{DropdownSelection}from"../../Utilities/DropdownSelection";import{ArrayItemProvider,getItemsValue}from"../../Utilities/Provider";export var DefaultListBoxWidth=-100;var ListBox=function(e){function t(t){var s=e.call(this,t)||this;s.tabbableIndex=-1,s.positions=[],s.count=0,s.table=React.createRef(),s.getItemWidth=function(){var e=s.props.width;return s.selection.multiSelect&&e&&e>0?e-40:e},s.loadingChanged=function(){return ObservableLike.getValue(s.props.loading)?Utils_Accessibility.announce(Resources.AnnounceLoadingItems):Utils_Accessibility.announce(Resources.AnnounceFinishedLoadingItems),!0},s.searchingChanged=function(){if(ObservableLike.getValue(s.props.loading))Utils_Accessibility.announce(Resources.Searching);else{var e=s.props.items.length;Utils_Accessibility.announce(e>0?format(Resources.AnnounceFilterResultCount,e):Resources.NoFilterResults,!0)}return!0},s.onItemsChanged=function(){var e=getListBoxItemsValue(s.wrappedItems||s.props.items);s.tabbableIndex=-1,s.positions=[],s.count=0;for(var t=0,o=e;t<o.length;t++){var i=o[t],l=ObservableLike.getValue(i);l&&!listBoxItemSelectable(l)?s.positions.push(-1):(-1===s.tabbableIndex&&s.selection.selectable(s.positions.length)&&(s.tabbableIndex=s.positions.length),s.positions.push(++s.count))}return!0},s.onActivate=function(e,t){s.props.onActivate&&s.props.onActivate(e,t.data)},s.onSelect=function(e,t){s.props.onSelect&&s.props.onSelect(e,t.data)},s.renderListBoxRow=function(e,t,o){var i=s.props,l=i.excludeFocusZone,n=i.excludeTabStop,r=getListBoxItemsValue(s.wrappedItems||s.props.items),a=e>0&&2===r[e-1].type?"header-"+r[e-1].id:o.ariaDescribedBy,c=!l&&s.selection.selectable(e),m=tslib_1.__assign({},o,{ariaDescribedBy:a,ariaPosInSet:s.positions[e]>=0?s.positions[e]:null,ariaSetSize:s.positions[e]>=0?s.count:null,excludeTabStop:n||s.tabbableIndex!==e,excludeFocusZone:!c,id:t.id,singleClickActivation:!1,role:2===t.type||3===t.type?"row":s.selection.multiSelect?"menuitemcheckbox":"option"});return React.createElement(Observer,{key:t.id||e,item:t},function(){return React.createElement(TableRow,{key:t.id||e,index:e,details:m,className:css("bolt-list-box-row",2===t.type&&"bolt-list-box-header-row",3===t.type&&"bolt-list-box-divider-row",4===t.type&&"bolt-list-box-loading-row",s.selection.multiSelect&&"bolt-list-box-multi-select-row",2!==t.type&&3!==t.type&&"cursor-pointer",t.disabled&&"bolt-list-box-item-disabled")},s.columns.map(function(o,i){if(s.selection.multiSelect&&0===i){if(3===t.type||4===t.type)return null;if(2===t.type)return renderEmptyCell(e,i)}return o.renderCell(e,i,o,t)}))})},s.renderListBoxCell=function(e,t,o,i){return renderListBoxCell(e,t,o,i,s.selection.multiSelect)};var o=s.props,i=o.selection,l=o.renderItem,n=o.items;return s.selection=i||new DropdownSelection,s.columns=s.selection.multiSelect?[new ColumnSelect]:[],s.columns.push({id:"text",width:s.getItemWidth(),renderCell:l||s.renderListBoxCell,className:css("bolt-list-box-text",s.selection.multiSelect?"bolt-list-box-text-multi-select":"bolt-list-box-text-single-select"),readonly:!0}),s.wrappedItems=wrapListBoxItems(n),s.onItemsChanged(),s}return tslib_1.__extends(t,e),t.prototype.componentDidUpdate=function(){this.props.didUpdate&&this.props.didUpdate()},t.prototype.render=function(){var e=this,t=this.props,s=t.className,o=t.containerClassName,i=t.focuszoneProps,l=t.getUnselectableRanges,n=t.items,r=t.loading,a=t.searching,c=t.searchResultsLoadingText,m=t.width,p={observableValue:n,filter:this.onItemsChanged},d=this.wrappedItems?new ArrayItemProvider(this.wrappedItems):Array.isArray(n)?new ArrayItemProvider(n):n;return this.columns[this.columns.length-1].width=this.getItemWidth(),React.createElement(ItemsObserver,{getUnselectableRanges:l,items:n,selection:this.selection},React.createElement(Observer,{items:p,loading:{observableValue:r||!1,filter:this.loadingChanged},searching:{observableValue:a||!1,filter:this.searchingChanged}},function(t){return t.searching?React.createElement("div",{className:"bolt-list-box-loading",style:{width:m}},React.createElement(Spinner,{size:"medium",label:c||Resources.Searching})):React.createElement(Table,{className:css(s,"bolt-list-box"),columns:e.columns,containerClassName:o,focuszoneProps:i,itemProvider:d,onActivate:e.onActivate,onSelect:e.onSelect,renderRow:e.renderListBoxRow,ref:e.table,role:e.selection.multiSelect?"menu":"listbox",scrollable:!0,singleClickActivation:!1,selection:e.selection,showHeader:!1,showLines:!1,spacerWidth:0})}))},t.prototype.scrollIntoView=function(e,t){if(this.table.current)return this.table.current.scrollIntoView(e,t)},t.defaultProps={getUnselectableRanges:getUnselectableRanges,width:DefaultListBoxWidth},t}(React.Component);export{ListBox};export function renderListBoxCell(e,t,s,o,i){return o.render?o.render(e,t,s,o):3===o.type?React.createElement(SimpleTableCell,{className:css(s.className,o.className,i&&"bolt-list-box-divider-multi-select"),columnIndex:t,colspan:i?2:1,key:o.id,tableColumn:s},React.createElement("div",{className:"bolt-list-box-divider flex-grow"})):4===o.type?React.createElement(LoadingCell,{columnIndex:t,key:o.id,tableColumn:s,tableItem:o}):React.createElement(SimpleTableCell,{className:css(s.className,o.className,2===o.type&&"bolt-list-box-header"),columnIndex:t,key:o.id,tableColumn:s},React.createElement("div",{id:2===o.type?"header-"+o.id:void 0,"aria-label":2===o.type?format(Resources.HeaderAriaLabel,o.text):void 0,className:"bolt-list-box-cell-container"},o&&renderListCell(o)))};export function getUnselectableRanges(e,t){void 0===t&&(t=listBoxItemSelectable);for(var s=[],o=-1,i=0;i<e.length;i++)!t(e[i])&&o<0?o=i:t(e[i])&&o>=0&&(s.push({beginIndex:o,endIndex:i-1}),o=-1);return o>=0&&s.push({beginIndex:o,endIndex:e.length-1}),s};export function listBoxItemSelectable(e){return 2!==e.type&&3!==e.type&&4!==e.type&&!e.disabled};export function wrapListBoxItems(e){if(Array.isArray(e)&&e.length&&"string"==typeof e[0])return e.map(function(e){return{id:e,text:e}})};export function getListBoxItemsValue(e){return $DEBUG&&Array.isArray(e)&&e.length&&"string"==typeof e[0]&&console.warn("a string[] was passed for items and not wrapped first.  Call wrapListBoxItems on items and pass in the results as items."),getItemsValue(e)};var LoadingCell=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.prototype.componentDidMount=function(){this.props.onMount&&this.props.onMount()},t.prototype.render=function(){var e=this.props,t=e.columnIndex,s=e.tableColumn,o=e.tableItem;return React.createElement(SimpleTableCell,{className:css(s.className,o.className),columnIndex:t,colspan:2,contentClassName:"justify-center",key:t,tableColumn:s},React.createElement("div",{className:"bolt-list-box-loading"},React.createElement(Spinner,{size:"medium",label:Resources.Loading})))},t}(React.Component);export{LoadingCell};